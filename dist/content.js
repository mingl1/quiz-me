const p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function j(s){let t="";for(let e=0;e<s.length;e+=3)t+=p[s[e]>>2],t+=p[(s[e]&3)<<4|s[e+1]>>4],t+=p[(s[e+1]&15)<<2|s[e+2]>>6],t+=p[s[e+2]&63];return s.length%3===2?t=t.substring(0,t.length-1)+"=":s.length%3===1&&(t=t.substring(0,t.length-2)+"=="),t}function H(s){let t=new Uint8Array(256);for(let n=0;n<p.length;n++)t[p.charCodeAt(n)]=n;let e=s.length*.75;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);let i=new Uint8Array(e);for(let n=0,h=0;n<s.length;n+=4){let a=t[s.charCodeAt(n)],l=t[s.charCodeAt(n+1)],u=t[s.charCodeAt(n+2)],d=t[s.charCodeAt(n+3)];i[h++]=a<<2|l>>4,i[h++]=(l&15)<<4|u>>2,i[h++]=(u&3)<<6|d&63}return i}function W(s,t,e,i){if(["32f","64"].indexOf(t)>-1&&["32f","64"].indexOf(i)>-1){e.set(s);return}b(t),b(i);let n=$(t,i),h={oldMin:Math.pow(2,parseInt(t,10))/2,newMin:Math.pow(2,parseInt(i,10))/2,oldMax:Math.pow(2,parseInt(t,10))/2-1,newMax:Math.pow(2,parseInt(i,10))/2-1};T(t,s,!0);for(let a=0,l=s.length;a<l;a++)e[a]=n(s[a],h);T(i,e,!1)}function V(s,t){return s>0?s=parseInt(s/t.oldMax*t.newMax,10):s=parseInt(s/t.oldMin*t.newMin,10),s}function G(s,t){return parseInt(s>0?s*t.newMax:s*t.newMin,10)}function q(s,t){return s>0?s/t.oldMax:s/t.oldMin}function $(s,t){let e=function(i){return i};return s!=t&&(["32f","64"].includes(s)?e=G:["32f","64"].includes(t)?e=q:e=V),e}function b(s){if(s!="32f"&&s!="64"&&(parseInt(s,10)<"8"||parseInt(s,10)>"53"))throw new Error("Invalid bit depth.")}function T(s,t,e){if(s=="8"){let i=e?-128:128;for(let n=0,h=t.length;n<h;n++)t[n]=t[n]+=i}}const U=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8],C=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767];function J(s){let t={index:0,predicted:0},e=new Uint8Array(s.length),i=[],n=0,h=0;for(let l=0,u=s.length;l<u;l++)l%505==0&&l!=0&&(e.set(Q(i,t),n),n+=256,i=[],h++),i.push(s[l]);let a=s.length/2;return a%2&&a++,e.slice(0,a+512+h*4)}function Z(s,t=256){let e={index:0,predicted:0,step:7},i=new Int16Array(s.length*2),n=[],h=0;for(let a=0,l=s.length;a<l;a++){if(a%t==0&&a!=0){let u=K(n,e);i.set(u,h),h+=u.length,n=[]}n.push(s[a])}return i}function Q(s,t){let e=it(s[0],t);for(let i=3,n=s.length;i<n;i+=2){let h=w(s[i],t),a=w(s[i+1],t);e.push(a<<4|h)}return e}function K(s,t){t.predicted=Y(s[1]<<8|s[0]),t.index=s[2],t.step=C[t.index];let e=[t.predicted,t.predicted];for(let i=4,n=s.length;i<n;i++){let h=s[i],a=h>>4,l=a<<4^h;e.push(y(l,t)),e.push(y(a,t))}return e}function Y(s){return s>32768?s-65536:s}function w(s,t){let e=s-t.predicted,i=0;e>=0?i=0:(i=8,e=-e);let n=C[t.index],h=n>>3;return e>n&&(i|=4,e-=n,h+=n),n>>=1,e>n&&(i|=2,e-=n,h+=n),n>>=1,e>n&&(i|=1,h+=n),tt(i,h,t),i}function tt(s,t,e){s&8?e.predicted-=t:e.predicted+=t,e.predicted<-32768?e.predicted=-32768:e.predicted>32767&&(e.predicted=32767),e.index+=U[s&7],e.index<0?e.index=0:e.index>88&&(e.index=88)}function y(s,t){let e=0;return s&4&&(e+=t.step),s&2&&(e+=t.step>>1),s&1&&(e+=t.step>>2),e+=t.step>>3,s&8&&(e=-e),t.predicted+=e,t.predicted>32767?t.predicted=32767:t.predicted<-32767&&(t.predicted=-32767),et(s,t),t.predicted}function et(s,t){t.index+=U[s],t.index<0?t.index=0:t.index>88&&(t.index=88),t.step=C[t.index]}function it(s,t){w(s,t);let e=[];return e.push(s&255),e.push(s>>8&255),e.push(t.index),e.push(0),e}const st=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function nt(s){let t;s=s==-32768?-32767:s;let e=~s>>8&128;if(e||(s=s*-1),s>32635&&(s=32635),s>=256){let i=st[s>>8&127],n=s>>i+3&15;t=i<<4|n}else t=s>>4;return t^(e^85)}function ht(s){let t=0;s^=85,(s&128)!==0&&(s&=-129,t=-1);let e=((s&240)>>4)+4,i=0;return e!=4?i=1<<e|(s&15)<<e-4|1<<e-5:i=s<<1|1,i=t===0?i:-i,i*8*-1}function at(s){let t=new Uint8Array(s.length);for(let e=0,i=s.length;e<i;e++)t[e]=nt(s[e]);return t}function rt(s){let t=new Int16Array(s.length);for(let e=0,i=s.length;e<i;e++)t[e]=ht(s[e]);return t}const lt=132,F=32635,ut=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],ot=[0,132,396,924,1980,4092,8316,16764];function dt(s){let t,e,i,n;return t=s>>8&128,t!=0&&(s=-s),s=s+lt,s>F&&(s=F),e=ut[s>>7&255],i=s>>e+3&15,n=~(t|e<<4|i),n}function ct(s){let t,e,i,n;return s=~s,t=s&128,e=s>>4&7,i=s&15,n=ot[e]+(i<<e+3),t!=0&&(n=-n),n}function ft(s){let t=new Uint8Array(s.length);for(let e=0,i=s.length;e<i;e++)t[e]=dt(s[e]);return t}function It(s){let t=new Int16Array(s.length);for(let e=0,i=s.length;e<i;e++)t[e]=ct(s[e]);return t}function E(s,t,e=0,i=s.length){for(let n=e;n<i;n+=t)gt(s,t,n)}function gt(s,t,e){t--;for(let i=0;i<t;i++){let n=s[e+i];s[e+i]=s[e+t],s[e+t]=n,t--}}function pt(s,t=0,e=s.length){let i="";for(let n=t;n<e;){let h=128,a=191,l=!1,u=s[n++];if(u>=0&&u<=127)i+=String.fromCharCode(u);else{let d=0;u>=194&&u<=223?d=1:u>=224&&u<=239?(d=2,s[n]===224&&(h=160),s[n]===237&&(a=159)):u>=240&&u<=244?(d=3,s[n]===240&&(h=144),s[n]===244&&(a=143)):l=!0,u=u&(1<<8-d-1)-1;for(let f=0;f<d;f++)(s[n]<h||s[n]>a)&&(l=!0),u=u<<6|s[n]&63,n++;l?i+="ï¿½":u<=65535?i+=String.fromCharCode(u):(u-=65536,i+=String.fromCharCode((u>>10&1023)+55296,(u&1023)+56320))}}return i}function R(s,t,e=0){let i=0,n=s.length;for(;i<n;){let h=s.codePointAt(i);if(h<128)t[e]=h,e++;else{let a=0,l=0;for(h<=2047?(a=1,l=192):h<=65535?(a=2,l=224):h<=1114111&&(a=3,l=240,i++),t[e]=(h>>6*a)+l,e++;a>0;)t[e]=128|h>>6*(a-1)&63,e++,a--}i++}return e}class kt{constructor(t,e=!1){this.bits=t,this.offset=Math.ceil(t/8),this.max=Math.pow(2,t)-1,this.min=0,this.unpack=this.unpack_,e&&(this.max=Math.pow(2,t)/2-1,this.min=-this.max-1,this.unpack=this.unpackSigned_)}pack(t,e,i=0){e=this.clamp_(Math.round(e));for(let n=0,h=this.offset;n<h;n++)t[i]=Math.floor(e/Math.pow(2,n*8))&255,i++;return i}unpack_(t,e=0){let i=0;for(let n=0;n<this.offset;n++)i+=t[e+n]*Math.pow(256,n);return i}unpackSigned_(t,e=0){return this.sign_(this.unpack_(t,e))}clamp_(t){return t>this.max?this.max:t<this.min?this.min:t}sign_(t){return t>this.max&&(t-=this.max*2+2),t}}class M{constructor(t,e){this.offset=Math.ceil((t+e)/8),this.ebits=t,this.fbits=e,this.bias=(1<<t-1)-1,this.biasP2=Math.pow(2,this.bias+1),this.ebitsFbits=t+e,this.fbias=Math.pow(2,-(8*this.offset-1-t))}pack(t,e,i){Math.abs(e)>this.biasP2-this.ebitsFbits*2&&(e=e<0?-1/0:1/0);let n=((e=+e)||1/e)<0||e<0?1:0;e=Math.abs(e);let h=Math.min(Math.floor(Math.log(e)/Math.LN2),1023),a=_(e/Math.pow(2,h)*Math.pow(2,this.fbits));return e!==e?(a=Math.pow(2,this.fbits-1),h=(1<<this.ebits)-1):e!==0&&(e>=Math.pow(2,1-this.bias)?(a/Math.pow(2,this.fbits)>=2&&(h=h+1,a=1),h>this.bias?(h=(1<<this.ebits)-1,a=0):(h=h+this.bias,a=_(a)-Math.pow(2,this.fbits))):(a=_(e/Math.pow(2,1-this.bias-this.fbits)),h=0)),this.packFloatBits_(t,i,n,h,a)}unpack(t,e){let i=(1<<this.ebits)-1,n,h="";for(let u=this.offset-1;u>=0;u--){let d=t[u+e].toString(2);h+="00000000".substring(d.length)+d}let a=h.charAt(0)=="1"?-1:1;h=h.substring(1);let l=parseInt(h.substring(0,this.ebits),2);return h=h.substring(this.ebits),l==i?parseInt(h,2)!==0?NaN:a*(1/0):(l===0?(l+=1,n=parseInt(h,2)):n=parseInt("1"+h,2),a*n*this.fbias*Math.pow(2,l-this.bias))}packFloatBits_(t,e,i,n,h){let a=[];a.push(i);for(let I=this.ebits;I>0;I-=1)a[I]=n%2?1:0,n=Math.floor(n/2);let l=a.length;for(let I=this.fbits;I>0;I-=1)a[l+I]=h%2?1:0,h=Math.floor(h/2);let u=a.join(""),d=this.offset+e-1,f=e;for(;d>=e;)t[d]=parseInt(u.substring(0,8),2),u=u.substring(8),d--,f++;return f}}function _(s){let t=Math.floor(s),e=s-t;return e<.5?t:e>.5||t%2?t+1:t}function k(s,t=0,e=s.length){return pt(s,t,e)}function o(s){let t=[];return R(s,t),t}function P(s,t,e=0){return R(s,t,e)}function O(s,t,e,i=0){t=t||{};let n=D(t.bits,t.fp,t.signed),h=Math.ceil(t.bits/8),a=0,l=i;for(let u=s.length;a<u;a++)i=n.pack(e,s[a],i);return t.be&&E(e,h,l,i),i}function g(s,t,e,i=0,n=s.length){t=t||{};let h=D(t.bits,t.fp,t.signed);if(n=St(s,i,n,h.offset),t.be){let a=mt(s);t.be&&E(a,h.offset,i,n),z(a,e,i,n,h)}else z(s,e,i,n,h)}function x(s,t,e,i=0){return O([s],t,e,i)}function r(s,t){let e=[];return x(s,t,e,0),e}function S(s,t,e=0){let i=[];return g(s,t,i,e,e+Math.ceil(t.bits/8)),i[0]}function z(s,t,e,i,n){let h=n.offset;for(let a=0,l=e;l<i;l+=h,a++)t[a]=n.unpack(s,l)}function mt(s){return new Uint8Array(s)}function St(s,t,e,i){let n=(e-t)%i;return e-n}function D(s,t,e){return t&&s==32?new M(8,23):t&&s==64?new M(11,52):new kt(s,e)}class _t{constructor(){this.container="",this.chunkSize=0,this.format="",this.signature=null,this.head=0,this.uInt32={bits:32,be:!1},this.supported_containers=["RIFF","RIFX"]}setSignature(t){if(this.head=0,this.container=this.readString(t,4),this.supported_containers.indexOf(this.container)===-1)throw Error("Not a supported format.");this.uInt32.be=this.container==="RIFX",this.chunkSize=this.readUInt32(t),this.format=this.readString(t,4),this.signature={chunkId:this.container,chunkSize:this.chunkSize,format:this.format,subChunks:this.getSubChunksIndex_(t)}}findChunk(t,e=!1){let i=this.signature.subChunks,n=[];for(let h=0;h<i.length;h++)if(i[h].chunkId==t)if(e)n.push(i[h]);else return i[h];return t=="LIST"&&n.length?n:null}readString(t,e){let i="";return i=k(t,this.head,this.head+e),this.head+=e,i}readUInt32(t){let e=S(t,this.uInt32,this.head);return this.head+=4,e}getSubChunksIndex_(t){let e=[],i=this.head;for(;i<=t.length-8;)e.push(this.getSubChunkIndex_(t,i)),i+=8+e[e.length-1].chunkSize,i=i%2?i+1:i;return e}getSubChunkIndex_(t,e){let i={chunkId:this.getChunkId_(t,e),chunkSize:this.getChunkSize_(t,e)};if(i.chunkId=="LIST")i.format=k(t,e+8,e+12),this.head+=4,i.subChunks=this.getSubChunksIndex_(t);else{let n=i.chunkSize%2?i.chunkSize+1:i.chunkSize;this.head=e+8+n,i.chunkData={start:e+8,end:this.head}}return i}getChunkId_(t,e){return this.head+=4,k(t,e,e+4)}getChunkSize_(t,e){return this.head+=4,S(t,this.uInt32,e+4)}}class L extends _t{constructor(){super(),this.supported_containers.push("RF64"),this.fmt={chunkId:"",chunkSize:0,audioFormat:0,numChannels:0,sampleRate:0,byteRate:0,blockAlign:0,bitsPerSample:0,cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]},this.fact={chunkId:"",chunkSize:0,dwSampleLength:0},this.cue={chunkId:"",chunkSize:0,dwCuePoints:0,points:[]},this.smpl={chunkId:"",chunkSize:0,dwManufacturer:0,dwProduct:0,dwSamplePeriod:0,dwMIDIUnityNote:0,dwMIDIPitchFraction:0,dwSMPTEFormat:0,dwSMPTEOffset:0,dwNumSampleLoops:0,dwSamplerData:0,loops:[]},this.bext={chunkId:"",chunkSize:0,description:"",originator:"",originatorReference:"",originationDate:"",originationTime:"",timeReference:[0,0],version:0,UMID:"",loudnessValue:0,loudnessRange:0,maxTruePeakLevel:0,maxMomentaryLoudness:0,maxShortTermLoudness:0,reserved:"",codingHistory:""},this.iXML={chunkId:"",chunkSize:0,value:""},this.ds64={chunkId:"",chunkSize:0,riffSizeHigh:0,riffSizeLow:0,dataSizeHigh:0,dataSizeLow:0,originationTime:0,sampleCountHigh:0,sampleCountLow:0},this.data={chunkId:"",chunkSize:0,samples:new Uint8Array(0)},this.LIST=[],this.junk={chunkId:"",chunkSize:0,chunkData:[]},this._PMX={chunkId:"",chunkSize:0,value:""},this.uInt16={bits:16,be:!1,signed:!1,fp:!1}}fromBuffer(t,e=!0){if(this.clearHeaders(),this.setSignature(t),this.uInt16.be=this.uInt32.be,this.format!="WAVE")throw Error('Could not find the "WAVE" format identifier');this.readDs64Chunk_(t),this.readFmtChunk_(t),this.readFactChunk_(t),this.readBextChunk_(t),this.readiXMLChunk_(t),this.readCueChunk_(t),this.readSmplChunk_(t),this.readDataChunk_(t,e),this.readJunkChunk_(t),this.readLISTChunk_(t),this.read_PMXChunk_(t)}clearHeaders(){let t=new L;Object.assign(this.fmt,t.fmt),Object.assign(this.fact,t.fact),Object.assign(this.cue,t.cue),Object.assign(this.smpl,t.smpl),Object.assign(this.bext,t.bext),Object.assign(this.iXML,t.iXML),Object.assign(this.ds64,t.ds64),Object.assign(this.data,t.data),this.LIST=[],Object.assign(this.junk,t.junk),Object.assign(this._PMX,t._PMX)}readFmtChunk_(t){let e=this.findChunk("fmt ");if(e)this.head=e.chunkData.start,this.fmt.chunkId=e.chunkId,this.fmt.chunkSize=e.chunkSize,this.fmt.audioFormat=this.readUInt16_(t),this.fmt.numChannels=this.readUInt16_(t),this.fmt.sampleRate=this.readUInt32(t),this.fmt.byteRate=this.readUInt32(t),this.fmt.blockAlign=this.readUInt16_(t),this.fmt.bitsPerSample=this.readUInt16_(t),this.readFmtExtension_(t);else throw Error('Could not find the "fmt " chunk')}readFmtExtension_(t){this.fmt.chunkSize>16&&(this.fmt.cbSize=this.readUInt16_(t),this.fmt.chunkSize>18&&(this.fmt.validBitsPerSample=this.readUInt16_(t),this.fmt.chunkSize>20&&(this.fmt.dwChannelMask=this.readUInt32(t),this.fmt.subformat=[this.readUInt32(t),this.readUInt32(t),this.readUInt32(t),this.readUInt32(t)])))}readFactChunk_(t){let e=this.findChunk("fact");e&&(this.head=e.chunkData.start,this.fact.chunkId=e.chunkId,this.fact.chunkSize=e.chunkSize,this.fact.dwSampleLength=this.readUInt32(t))}readCueChunk_(t){let e=this.findChunk("cue ");if(e){this.head=e.chunkData.start,this.cue.chunkId=e.chunkId,this.cue.chunkSize=e.chunkSize,this.cue.dwCuePoints=this.readUInt32(t);for(let i=0;i<this.cue.dwCuePoints;i++)this.cue.points.push({dwName:this.readUInt32(t),dwPosition:this.readUInt32(t),fccChunk:this.readString(t,4),dwChunkStart:this.readUInt32(t),dwBlockStart:this.readUInt32(t),dwSampleOffset:this.readUInt32(t)})}}readSmplChunk_(t){let e=this.findChunk("smpl");if(e){this.head=e.chunkData.start,this.smpl.chunkId=e.chunkId,this.smpl.chunkSize=e.chunkSize,this.smpl.dwManufacturer=this.readUInt32(t),this.smpl.dwProduct=this.readUInt32(t),this.smpl.dwSamplePeriod=this.readUInt32(t),this.smpl.dwMIDIUnityNote=this.readUInt32(t),this.smpl.dwMIDIPitchFraction=this.readUInt32(t),this.smpl.dwSMPTEFormat=this.readUInt32(t),this.smpl.dwSMPTEOffset=this.readUInt32(t),this.smpl.dwNumSampleLoops=this.readUInt32(t),this.smpl.dwSamplerData=this.readUInt32(t);for(let i=0;i<this.smpl.dwNumSampleLoops;i++)this.smpl.loops.push({dwName:this.readUInt32(t),dwType:this.readUInt32(t),dwStart:this.readUInt32(t),dwEnd:this.readUInt32(t),dwFraction:this.readUInt32(t),dwPlayCount:this.readUInt32(t)})}}readDataChunk_(t,e){let i=this.findChunk("data");if(i)this.data.chunkId="data",this.data.chunkSize=i.chunkSize,e&&(this.data.samples=t.slice(i.chunkData.start,i.chunkData.end));else throw Error('Could not find the "data" chunk')}readBextChunk_(t){let e=this.findChunk("bext");e&&(this.head=e.chunkData.start,this.bext.chunkId=e.chunkId,this.bext.chunkSize=e.chunkSize,this.bext.description=this.readString(t,256),this.bext.originator=this.readString(t,32),this.bext.originatorReference=this.readString(t,32),this.bext.originationDate=this.readString(t,10),this.bext.originationTime=this.readString(t,8),this.bext.timeReference=[this.readUInt32(t),this.readUInt32(t)],this.bext.version=this.readUInt16_(t),this.bext.UMID=this.readString(t,64),this.bext.loudnessValue=this.readUInt16_(t),this.bext.loudnessRange=this.readUInt16_(t),this.bext.maxTruePeakLevel=this.readUInt16_(t),this.bext.maxMomentaryLoudness=this.readUInt16_(t),this.bext.maxShortTermLoudness=this.readUInt16_(t),this.bext.reserved=this.readString(t,180),this.bext.codingHistory=this.readString(t,this.bext.chunkSize-602))}readiXMLChunk_(t){let e=this.findChunk("iXML");e&&(this.head=e.chunkData.start,this.iXML.chunkId=e.chunkId,this.iXML.chunkSize=e.chunkSize,this.iXML.value=k(t,this.head,this.head+this.iXML.chunkSize))}readDs64Chunk_(t){let e=this.findChunk("ds64");if(e)this.head=e.chunkData.start,this.ds64.chunkId=e.chunkId,this.ds64.chunkSize=e.chunkSize,this.ds64.riffSizeHigh=this.readUInt32(t),this.ds64.riffSizeLow=this.readUInt32(t),this.ds64.dataSizeHigh=this.readUInt32(t),this.ds64.dataSizeLow=this.readUInt32(t),this.ds64.originationTime=this.readUInt32(t),this.ds64.sampleCountHigh=this.readUInt32(t),this.ds64.sampleCountLow=this.readUInt32(t);else if(this.container=="RF64")throw Error('Could not find the "ds64" chunk')}readLISTChunk_(t){let e=this.findChunk("LIST",!0);if(e!==null)for(let i=0;i<e.length;i++){let n=e[i];this.LIST.push({chunkId:n.chunkId,chunkSize:n.chunkSize,format:n.format,subChunks:[]});for(let h=0;h<n.subChunks.length;h++)this.readLISTSubChunks_(n.subChunks[h],n.format,t)}}readLISTSubChunks_(t,e,i){e=="adtl"?["labl","note","ltxt"].indexOf(t.chunkId)>-1&&this.readLISTadtlSubChunks_(i,t):e=="INFO"&&this.readLISTINFOSubChunks_(i,t)}readLISTadtlSubChunks_(t,e){this.head=e.chunkData.start;let i={chunkId:e.chunkId,chunkSize:e.chunkSize,dwName:this.readUInt32(t)};e.chunkId=="ltxt"?(i.dwSampleLength=this.readUInt32(t),i.dwPurposeID=this.readUInt32(t),i.dwCountry=this.readUInt16_(t),i.dwLanguage=this.readUInt16_(t),i.dwDialect=this.readUInt16_(t),i.dwCodePage=this.readUInt16_(t),i.value=""):i.value=this.readZSTR_(t,this.head),this.LIST[this.LIST.length-1].subChunks.push(i)}readLISTINFOSubChunks_(t,e){this.head=e.chunkData.start,this.LIST[this.LIST.length-1].subChunks.push({chunkId:e.chunkId,chunkSize:e.chunkSize,value:this.readZSTR_(t,this.head)})}readJunkChunk_(t){let e=this.findChunk("junk");e&&(this.junk={chunkId:e.chunkId,chunkSize:e.chunkSize,chunkData:[].slice.call(t.slice(e.chunkData.start,e.chunkData.end))})}read_PMXChunk_(t){let e=this.findChunk("_PMX");e&&(this.head=e.chunkData.start,this._PMX.chunkId=e.chunkId,this._PMX.chunkSize=e.chunkSize,this._PMX.value=k(t,this.head,this.head+this._PMX.chunkSize))}readZSTR_(t,e=0){for(let i=e;i<t.length&&(this.head++,t[i]!==0);i++);return k(t,e,this.head-1)}readUInt16_(t){let e=S(t,this.uInt16,this.head);return this.head+=2,e}}function c(s,t){let e=o(s);for(let i=e.length;i<t;i++)e.push(0);return e}class wt extends L{toBuffer(){this.uInt16.be=this.container==="RIFX",this.uInt32.be=this.uInt16.be;let t=[this.getJunkBytes_(),this.getDs64Bytes_(),this.getBextBytes_(),this.getiXMLBytes_(),this.getFmtBytes_(),this.getFactBytes_(),o(this.data.chunkId),r(this.data.samples.length,this.uInt32),this.data.samples,this.getCueBytes_(),this.getSmplBytes_(),this.getLISTBytes_(),this.get_PMXBytes_()],e=0;for(let h=0;h<t.length;h++)e+=t[h].length;let i=new Uint8Array(e+12),n=0;n=P(this.container,i,n),n=x(e+4,this.uInt32,i,n),n=P(this.format,i,n);for(let h=0;h<t.length;h++)i.set(t[h],n),n+=t[h].length;return i}getBextBytes_(){let t=[];return this.enforceBext_(),this.bext.chunkId&&(this.bext.chunkSize=602+this.bext.codingHistory.length,t=t.concat(o(this.bext.chunkId),r(602+this.bext.codingHistory.length,this.uInt32),c(this.bext.description,256),c(this.bext.originator,32),c(this.bext.originatorReference,32),c(this.bext.originationDate,10),c(this.bext.originationTime,8),r(this.bext.timeReference[0],this.uInt32),r(this.bext.timeReference[1],this.uInt32),r(this.bext.version,this.uInt16),c(this.bext.UMID,64),r(this.bext.loudnessValue,this.uInt16),r(this.bext.loudnessRange,this.uInt16),r(this.bext.maxTruePeakLevel,this.uInt16),r(this.bext.maxMomentaryLoudness,this.uInt16),r(this.bext.maxShortTermLoudness,this.uInt16),c(this.bext.reserved,180),c(this.bext.codingHistory,this.bext.codingHistory.length))),this.enforceByteLen_(t),t}enforceBext_(){for(let t in this.bext)if(this.bext.hasOwnProperty(t)&&this.bext[t]&&t!="timeReference"){this.bext.chunkId="bext";break}(this.bext.timeReference[0]||this.bext.timeReference[1])&&(this.bext.chunkId="bext")}getiXMLBytes_(){let t=[];if(this.iXML.chunkId){let e=o(this.iXML.value);this.iXML.chunkSize=e.length,t=t.concat(o(this.iXML.chunkId),r(this.iXML.chunkSize,this.uInt32),e)}return this.enforceByteLen_(t),t}getDs64Bytes_(){let t=[];return this.ds64.chunkId&&(t=t.concat(o(this.ds64.chunkId),r(this.ds64.chunkSize,this.uInt32),r(this.ds64.riffSizeHigh,this.uInt32),r(this.ds64.riffSizeLow,this.uInt32),r(this.ds64.dataSizeHigh,this.uInt32),r(this.ds64.dataSizeLow,this.uInt32),r(this.ds64.originationTime,this.uInt32),r(this.ds64.sampleCountHigh,this.uInt32),r(this.ds64.sampleCountLow,this.uInt32))),this.enforceByteLen_(t),t}getCueBytes_(){let t=[];if(this.cue.chunkId){let e=this.getCuePointsBytes_();t=t.concat(o(this.cue.chunkId),r(e.length+4,this.uInt32),r(this.cue.dwCuePoints,this.uInt32),e)}return this.enforceByteLen_(t),t}getCuePointsBytes_(){let t=[];for(let e=0;e<this.cue.dwCuePoints;e++)t=t.concat(r(this.cue.points[e].dwName,this.uInt32),r(this.cue.points[e].dwPosition,this.uInt32),o(this.cue.points[e].fccChunk),r(this.cue.points[e].dwChunkStart,this.uInt32),r(this.cue.points[e].dwBlockStart,this.uInt32),r(this.cue.points[e].dwSampleOffset,this.uInt32));return t}getSmplBytes_(){let t=[];if(this.smpl.chunkId){let e=this.getSmplLoopsBytes_();t=t.concat(o(this.smpl.chunkId),r(e.length+36,this.uInt32),r(this.smpl.dwManufacturer,this.uInt32),r(this.smpl.dwProduct,this.uInt32),r(this.smpl.dwSamplePeriod,this.uInt32),r(this.smpl.dwMIDIUnityNote,this.uInt32),r(this.smpl.dwMIDIPitchFraction,this.uInt32),r(this.smpl.dwSMPTEFormat,this.uInt32),r(this.smpl.dwSMPTEOffset,this.uInt32),r(this.smpl.dwNumSampleLoops,this.uInt32),r(this.smpl.dwSamplerData,this.uInt32),e)}return this.enforceByteLen_(t),t}getSmplLoopsBytes_(){let t=[];for(let e=0;e<this.smpl.dwNumSampleLoops;e++)t=t.concat(r(this.smpl.loops[e].dwName,this.uInt32),r(this.smpl.loops[e].dwType,this.uInt32),r(this.smpl.loops[e].dwStart,this.uInt32),r(this.smpl.loops[e].dwEnd,this.uInt32),r(this.smpl.loops[e].dwFraction,this.uInt32),r(this.smpl.loops[e].dwPlayCount,this.uInt32));return t}getFactBytes_(){let t=[];return this.fact.chunkId&&(t=t.concat(o(this.fact.chunkId),r(this.fact.chunkSize,this.uInt32),r(this.fact.dwSampleLength,this.uInt32))),this.enforceByteLen_(t),t}getFmtBytes_(){let t=[];if(this.fmt.chunkId){let e=t.concat(o(this.fmt.chunkId),r(this.fmt.chunkSize,this.uInt32),r(this.fmt.audioFormat,this.uInt16),r(this.fmt.numChannels,this.uInt16),r(this.fmt.sampleRate,this.uInt32),r(this.fmt.byteRate,this.uInt32),r(this.fmt.blockAlign,this.uInt16),r(this.fmt.bitsPerSample,this.uInt16),this.getFmtExtensionBytes_());return this.enforceByteLen_(e),e}throw Error('Could not find the "fmt " chunk')}getFmtExtensionBytes_(){let t=[];return this.fmt.chunkSize>16&&(t=t.concat(r(this.fmt.cbSize,this.uInt16))),this.fmt.chunkSize>18&&(t=t.concat(r(this.fmt.validBitsPerSample,this.uInt16))),this.fmt.chunkSize>20&&(t=t.concat(r(this.fmt.dwChannelMask,this.uInt32))),this.fmt.chunkSize>24&&(t=t.concat(r(this.fmt.subformat[0],this.uInt32),r(this.fmt.subformat[1],this.uInt32),r(this.fmt.subformat[2],this.uInt32),r(this.fmt.subformat[3],this.uInt32))),t}getLISTBytes_(){let t=[];for(let e=0;e<this.LIST.length;e++){let i=this.getLISTSubChunksBytes_(this.LIST[e].subChunks,this.LIST[e].format);t=t.concat(o(this.LIST[e].chunkId),r(i.length+4,this.uInt32),o(this.LIST[e].format),i)}return this.enforceByteLen_(t),t}getLISTSubChunksBytes_(t,e){let i=[];for(let n=0,h=t.length;n<h;n++)e=="INFO"?i=i.concat(this.getLISTINFOSubChunksBytes_(t[n])):e=="adtl"&&(i=i.concat(this.getLISTadtlSubChunksBytes_(t[n]))),this.enforceByteLen_(i);return i}getLISTINFOSubChunksBytes_(t){let e=[],i=c(t.value,t.value.length);return e=e.concat(o(t.chunkId),r(i.length+1,this.uInt32),i),e.push(0),e}getLISTadtlSubChunksBytes_(t){let e=[];if(["labl","note"].indexOf(t.chunkId)>-1){let i=c(t.value,t.value.length);e=e.concat(o(t.chunkId),r(i.length+4+1,this.uInt32),r(t.dwName,this.uInt32),i),e.push(0)}else t.chunkId=="ltxt"&&(e=e.concat(this.getLtxtChunkBytes_(t)));return e}getLtxtChunkBytes_(t){return[].concat(o(t.chunkId),r(t.value.length+20,this.uInt32),r(t.dwName,this.uInt32),r(t.dwSampleLength,this.uInt32),r(t.dwPurposeID,this.uInt32),r(t.dwCountry,this.uInt16),r(t.dwLanguage,this.uInt16),r(t.dwDialect,this.uInt16),r(t.dwCodePage,this.uInt16),c(t.value,t.value.length))}get_PMXBytes_(){let t=[];if(this._PMX.chunkId){let e=o(this._PMX.value);this._PMX.chunkSize=e.length,t=t.concat(o(this._PMX.chunkId),r(this._PMX.chunkSize,this.uInt32),e)}return this.enforceByteLen_(t),t}getJunkBytes_(){let t=[];return this.junk.chunkId?t.concat(o(this.junk.chunkId),r(this.junk.chunkData.length,this.uInt32),this.junk.chunkData):(this.enforceByteLen_(t),t)}enforceByteLen_(t){t.length%2&&t.push(0)}}function Ct(s){let t=[];if(s.length>0)if(s[0].constructor!==Number){t=new Float64Array(s[0].length*s.length);for(let e=0,i=s[0].length,n=0;e<i;e++)for(let h=0,a=s.length;h<a;h++,n++)t[n]=s[h][e]}else t=s;return t}function xt(s,t,e=Float64Array){let i=[];for(let n=0;n<t;n++)i[n]=new e(s.length/t);for(let n=0;n<t;n++)for(let h=n,a=0;h<s.length;h+=t,a++)i[n][a]=s[h];return i}function Lt(s,t){let e=s*t/8;return!(s<1||e>65535)}function X(s,t,e){let i=s*(t/8)*e;return!(e<1||i>4294967295)}class bt extends wt{constructor(){super(),this.bitDepth="0",this.dataType={bits:0,be:!1},this.WAV_AUDIO_FORMATS={4:17,8:1,"8a":6,"8m":7,16:1,24:1,32:1,"32f":3,64:3}}fromScratch(t,e,i,n,h){h=h||{},this.clearHeaders(),this.newWavFile_(t,e,i,n,h)}fromBuffer(t,e=!0){super.fromBuffer(t,e),this.bitDepthFromFmt_(),this.updateDataType_()}toBuffer(){return this.validateWavHeader_(),super.toBuffer()}getSamples(t=!1,e=Float64Array){let i=new e(this.data.samples.length/(this.dataType.bits/8));return g(this.data.samples,this.dataType,i,0,this.data.samples.length),!t&&this.fmt.numChannels>1?xt(i,this.fmt.numChannels,e):i}getSample(t){if(t=t*(this.dataType.bits/8),t+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");return S(this.data.samples.slice(t,t+this.dataType.bits/8),this.dataType)}setSample(t,e){if(t=t*(this.dataType.bits/8),t+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");x(e,this.dataType,this.data.samples,t)}getiXML(){return this.iXML.value}setiXML(t){if(typeof t!="string")throw new TypeError("iXML value must be a string.");this.iXML.value=t,this.iXML.chunkId="iXML"}get_PMX(){return this._PMX.value}set_PMX(t){if(typeof t!="string")throw new TypeError("_PMX value must be a string.");this._PMX.value=t,this._PMX.chunkId="_PMX"}newWavFile_(t,e,i,n,h){h.container||(h.container="RIFF"),this.container=h.container,this.bitDepth=i,n=Ct(n),this.updateDataType_();let a=this.dataType.bits/8;this.data.samples=new Uint8Array(n.length*a),O(n,this.dataType,this.data.samples,0),this.makeWavHeader_(i,t,e,a,this.data.samples.length,h),this.data.chunkId="data",this.data.chunkSize=this.data.samples.length,this.validateWavHeader_()}makeWavHeader_(t,e,i,n,h,a){t=="4"?this.createADPCMHeader_(t,e,i,n,h,a):t=="8a"||t=="8m"?this.createALawMulawHeader_(t,e,i,n,h,a):Object.keys(this.WAV_AUDIO_FORMATS).indexOf(t)==-1||e>2?this.createExtensibleHeader_(t,e,i,n,h,a):this.createPCMHeader_(t,e,i,n,h,a)}createPCMHeader_(t,e,i,n,h,a){this.container=a.container,this.chunkSize=36+h,this.format="WAVE",this.bitDepth=t,this.fmt={chunkId:"fmt ",chunkSize:16,audioFormat:this.WAV_AUDIO_FORMATS[t]||65534,numChannels:e,sampleRate:i,byteRate:e*n*i,blockAlign:e*n,bitsPerSample:parseInt(t,10),cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]}}createADPCMHeader_(t,e,i,n,h,a){this.createPCMHeader_(t,e,i,n,h,a),this.chunkSize=40+h,this.fmt.chunkSize=20,this.fmt.byteRate=4055,this.fmt.blockAlign=256,this.fmt.bitsPerSample=4,this.fmt.cbSize=2,this.fmt.validBitsPerSample=505,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:h*2}}createExtensibleHeader_(t,e,i,n,h,a){this.createPCMHeader_(t,e,i,n,h,a),this.chunkSize=60+h,this.fmt.chunkSize=40,this.fmt.bitsPerSample=(parseInt(t,10)-1|7)+1,this.fmt.cbSize=22,this.fmt.validBitsPerSample=parseInt(t,10),this.fmt.dwChannelMask=Tt(e),this.fmt.subformat=[1,1048576,2852126848,1905997824]}createALawMulawHeader_(t,e,i,n,h,a){this.createPCMHeader_(t,e,i,n,h,a),this.chunkSize=40+h,this.fmt.chunkSize=20,this.fmt.cbSize=2,this.fmt.validBitsPerSample=8,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:h}}bitDepthFromFmt_(){this.fmt.audioFormat===3&&this.fmt.bitsPerSample===32?this.bitDepth="32f":this.fmt.audioFormat===6?this.bitDepth="8a":this.fmt.audioFormat===7?this.bitDepth="8m":this.bitDepth=this.fmt.bitsPerSample.toString()}validateBitDepth_(){if(!this.WAV_AUDIO_FORMATS[this.bitDepth]){if(parseInt(this.bitDepth,10)>8&&parseInt(this.bitDepth,10)<54)return!0;throw new Error("Invalid bit depth.")}return!0}updateDataType_(){this.dataType={bits:(parseInt(this.bitDepth,10)-1|7)+1,fp:this.bitDepth=="32f"||this.bitDepth=="64",signed:this.bitDepth!="8",be:this.container=="RIFX"},["4","8a","8m"].indexOf(this.bitDepth)>-1&&(this.dataType.bits=8,this.dataType.signed=!1)}validateWavHeader_(){if(this.validateBitDepth_(),!Lt(this.fmt.numChannels,this.fmt.bitsPerSample))throw new Error("Invalid number of channels.");if(!X(this.fmt.numChannels,this.fmt.bitsPerSample,this.fmt.sampleRate))throw new Error("Invalid sample rate.")}}function Tt(s){let t=0;return s===1?t=4:s===2?t=3:s===4?t=51:s===6?t=63:s===8&&(t=1599),t}class yt extends bt{getTag(t){let e=this.getTagIndex_(t);return e.TAG!==null?this.LIST[e.LIST].subChunks[e.TAG].value:null}setTag(t,e){t=Ft(t);let i=this.getTagIndex_(t);i.TAG!==null?(this.LIST[i.LIST].subChunks[i.TAG].chunkSize=e.length+1,this.LIST[i.LIST].subChunks[i.TAG].value=e):i.LIST!==null?this.LIST[i.LIST].subChunks.push({chunkId:t,chunkSize:e.length+1,value:e}):(this.LIST.push({chunkId:"LIST",chunkSize:8+e.length+1,format:"INFO",subChunks:[]}),this.LIST[this.LIST.length-1].subChunks.push({chunkId:t,chunkSize:e.length+1,value:e}))}deleteTag(t){let e=this.getTagIndex_(t);return e.TAG!==null?(this.LIST[e.LIST].subChunks.splice(e.TAG,1),!0):!1}listTags(){let t=this.getLISTIndex("INFO"),e={};if(t!==null)for(let i=0,n=this.LIST[t].subChunks.length;i<n;i++)e[this.LIST[t].subChunks[i].chunkId]=this.LIST[t].subChunks[i].value;return e}getLISTIndex(t){for(let e=0,i=this.LIST.length;e<i;e++)if(this.LIST[e].format==t)return e;return null}getTagIndex_(t){let e={LIST:null,TAG:null};for(let i=0,n=this.LIST.length;i<n;i++)if(this.LIST[i].format=="INFO"){e.LIST=i;for(let h=0,a=this.LIST[i].subChunks.length;h<a;h++)if(this.LIST[i].subChunks[h].chunkId==t){e.TAG=h;break}break}return e}}function Ft(s){if(s.constructor!==String)throw new Error("Invalid tag name.");if(s.length<4)for(let t=0,e=4-s.length;t<e;t++)s+=" ";return s}class B extends yt{listCuePoints(){let t=this.getCuePoints_();for(let e=0,i=t.length;e<i;e++)t[e].position=t[e].dwSampleOffset/this.fmt.sampleRate*1e3,t[e].dwSampleLength?(t[e].end=t[e].dwSampleLength/this.fmt.sampleRate*1e3,t[e].end+=t[e].position):t[e].end=null,delete t[e].value;return t}setCuePoint(t){this.cue.chunkId="cue ",t.label||(t.label="");let e=this.getCuePoints_();this.clearLISTadtl_(),this.cue.points=[],t.dwSampleOffset=t.position*this.fmt.sampleRate/1e3,t.dwSampleLength=0,t.end&&(t.dwSampleLength=t.end*this.fmt.sampleRate/1e3-t.dwSampleOffset),e.length===0?this.setCuePoint_(t,1):this.setCuePointInOrder_(e,t),this.cue.dwCuePoints=this.cue.points.length}deleteCuePoint(t){this.cue.chunkId="cue ";let e=this.getCuePoints_();this.clearLISTadtl_();let i=this.cue.points.length;this.cue.points=[];for(let n=0;n<i;n++)n+1!==t&&this.setCuePoint_(e[n],n+1);this.cue.dwCuePoints=this.cue.points.length,this.cue.dwCuePoints?this.cue.chunkId="cue ":(this.cue.chunkId="",this.clearLISTadtl_())}updateLabel(t,e){let i=this.getLISTIndex("adtl");if(i!==null)for(let n=0,h=this.LIST[i].subChunks.length;n<h;n++)this.LIST[i].subChunks[n].dwName==t&&(this.LIST[i].subChunks[n].value=e)}getCuePoints_(){let t=[];for(let e=0;e<this.cue.points.length;e++){let i=this.cue.points[e],n=this.getDataForCuePoint_(i.dwName);n.label=n.value?n.value:"",n.dwPosition=i.dwPosition,n.fccChunk=i.fccChunk,n.dwChunkStart=i.dwChunkStart,n.dwBlockStart=i.dwBlockStart,n.dwSampleOffset=i.dwSampleOffset,t.push(n)}return t}getDataForCuePoint_(t){let e=this.getLISTIndex("adtl"),i={};return e!==null&&this.getCueDataFromLIST_(i,e,t),i}getCueDataFromLIST_(t,e,i){for(let n=0,h=this.LIST[e].subChunks.length;n<h;n++)if(this.LIST[e].subChunks[n].dwName==i){let a=this.LIST[e].subChunks[n];t.value=a.value||t.value,t.dwName=a.dwName||0,t.dwSampleLength=a.dwSampleLength||0,t.dwPurposeID=a.dwPurposeID||0,t.dwCountry=a.dwCountry||0,t.dwLanguage=a.dwLanguage||0,t.dwDialect=a.dwDialect||0,t.dwCodePage=a.dwCodePage||0}}setCuePoint_(t,e){this.cue.points.push({dwName:e,dwPosition:t.dwPosition?t.dwPosition:0,fccChunk:t.fccChunk?t.fccChunk:"data",dwChunkStart:t.dwChunkStart?t.dwChunkStart:0,dwBlockStart:t.dwBlockStart?t.dwBlockStart:0,dwSampleOffset:t.dwSampleOffset}),this.setLabl_(t,e)}setCuePointInOrder_(t,e){let i=!1;for(let n=0;n<t.length;n++)t[n].dwSampleOffset>e.dwSampleOffset&&!i?(this.setCuePoint_(e,n+1),this.setCuePoint_(t[n],n+2),i=!0):this.setCuePoint_(t[n],i?n+2:n+1);i||this.setCuePoint_(e,this.cue.points.length+1)}clearLISTadtl_(){for(let t=0,e=this.LIST.length;t<e;t++)this.LIST[t].format=="adtl"&&this.LIST.splice(t)}setLabl_(t,e){let i=this.getLISTIndex("adtl");i===null&&(this.LIST.push({chunkId:"LIST",chunkSize:4,format:"adtl",subChunks:[]}),i=this.LIST.length-1),this.setLabelText_(i,t,e),t.dwSampleLength&&this.setLtxtChunk_(i,t,e)}setLabelText_(t,e,i){this.LIST[t].subChunks.push({chunkId:"labl",chunkSize:4,dwName:i,value:e.label}),this.LIST[t].chunkSize+=12}setLtxtChunk_(t,e,i){this.LIST[t].subChunks.push({chunkId:"ltxt",chunkSize:20,dwName:i,dwSampleLength:e.dwSampleLength,dwPurposeID:e.dwPurposeID||0,dwCountry:e.dwCountry||0,dwLanguage:e.dwLanguage||0,dwDialect:e.dwDialect||0,dwCodePage:e.dwCodePage||0,value:e.label}),this.LIST[t].chunkSize+=28}}class Mt{constructor(t,e,i){this.length_=t,this.scaleFactor_=(t-1)/e,this.interpolate=this.sinc,i.method==="point"?this.interpolate=this.point:i.method==="linear"?this.interpolate=this.linear:i.method==="cubic"&&(this.interpolate=this.cubic),this.tangentFactor_=1-Math.max(0,Math.min(1,i.tension||0)),this.sincFilterSize_=i.sincFilterSize||1,this.kernel_=zt(i.sincWindow||Pt)}point(t,e){return this.getClippedInput_(Math.round(this.scaleFactor_*t),e)}linear(t,e){t=this.scaleFactor_*t;let i=Math.floor(t);return t-=i,(1-t)*this.getClippedInput_(i,e)+t*this.getClippedInput_(i+1,e)}cubic(t,e){t=this.scaleFactor_*t;let i=Math.floor(t),n=[this.getTangent_(i,e),this.getTangent_(i+1,e)],h=[this.getClippedInput_(i,e),this.getClippedInput_(i+1,e)];t-=i;let a=t*t,l=t*a;return(2*l-3*a+1)*h[0]+(l-2*a+t)*n[0]+(-2*l+3*a)*h[1]+(l-a)*n[1]}sinc(t,e){t=this.scaleFactor_*t;let i=Math.floor(t),n=i-this.sincFilterSize_+1,h=i+this.sincFilterSize_,a=0;for(let l=n;l<=h;l++)a+=this.kernel_(t-l)*this.getClippedInput_(l,e);return a}getTangent_(t,e){return this.tangentFactor_*(this.getClippedInput_(t+1,e)-this.getClippedInput_(t-1,e))/2}getClippedInput_(t,e){return 0<=t&&t<this.length_?e[t]:0}}function Pt(s){return Math.exp(-s/2*s/2)}function zt(s){return function(t){return Bt(t)*s(t)}}function Bt(s){return s===0?1:Math.sin(Math.PI*s)/(Math.PI*s)}class At{constructor(t,e,i){let n=2*Math.PI*i/e,h=0;this.filters=[];for(let a=0;a<=t;a++)a-t/2===0?this.filters[a]=n:(this.filters[a]=Math.sin(n*(a-t/2))/(a-t/2),this.filters[a]*=.54-.46*Math.cos(2*Math.PI*a/t)),h=h+this.filters[a];for(let a=0;a<=t;a++)this.filters[a]/=h;this.z=this.initZ_()}filter(t){this.z.buf[this.z.pointer]=t;let e=0;for(let i=0,n=this.z.buf.length;i<n;i++)e+=this.filters[i]*this.z.buf[(this.z.pointer+i)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,e}reset(){this.z=this.initZ_()}initZ_(){let t=[];for(let e=0;e<this.filters.length-1;e++)t.push(0);return{buf:t,pointer:0}}}class vt{constructor(t,e,i){let n=[];for(let h=0;h<t;h++)n.push(this.getCoeffs_({Fs:e,Fc:i,Q:.5/Math.sin(Math.PI/(t*2)*(h+.5))}));this.stages=[];for(let h=0;h<n.length;h++)this.stages[h]={b0:n[h].b[0],b1:n[h].b[1],b2:n[h].b[2],a1:n[h].a[0],a2:n[h].a[1],k:n[h].k,z:[0,0]}}filter(t){let e=t;for(let i=0,n=this.stages.length;i<n;i++)e=this.runStage_(i,e);return e}getCoeffs_(t){let e={};e.a=[],e.b=[];let i=this.preCalc_(t,e);return e.k=1,e.b.push((1-i.cw)/(2*i.a0)),e.b.push(2*e.b[0]),e.b.push(e.b[0]),e}preCalc_(t,e){let i={},n=2*Math.PI*t.Fc/t.Fs;return i.alpha=Math.sin(n)/(2*t.Q),i.cw=Math.cos(n),i.a0=1+i.alpha,e.a0=i.a0,e.a.push(-2*i.cw/i.a0),e.k=1,e.a.push((1-i.alpha)/i.a0),i}runStage_(t,e){let i=e*this.stages[t].k-this.stages[t].a1*this.stages[t].z[0]-this.stages[t].a2*this.stages[t].z[1],n=this.stages[t].b0*i+this.stages[t].b1*this.stages[t].z[0]+this.stages[t].b2*this.stages[t].z[1];return this.stages[t].z[1]=this.stages[t].z[0],this.stages[t].z[0]=i,n}reset(){for(let t=0;t<this.stages.length;t++)this.stages[t].z=[0,0]}}const Ut={point:!1,linear:!1,cubic:!0,sinc:!0},A={IIR:16,FIR:71},Et={IIR:vt,FIR:At};function v(s,t,e,i=null){i=i||{};let n=(e-t)/t+1,h=new Float64Array(s.length*n);i.method=i.method||"cubic";let a=new Mt(s.length,h.length,{method:i.method,tension:i.tension||0,sincFilterSize:i.sincFilterSize||6,sincWindow:i.sincWindow||void 0,clip:i.clip||"mirror"});if(i.LPF===void 0&&(i.LPF=Ut[i.method]),i.LPF){i.LPFType=i.LPFType||"IIR";const l=Et[i.LPFType];if(e>t){let u=new l(i.LPForder||A[i.LPFType],e,t/2);Rt(s,h,a,u)}else{let u=new l(i.LPForder||A[i.LPFType],t,e/2);Ot(s,h,a,u)}}else N(s,h,a);return h}function N(s,t,e){for(let i=0,n=t.length;i<n;i++)t[i]=e.interpolate(i,s)}function Rt(s,t,e,i){for(let n=0,h=t.length;n<h;n++)t[n]=i.filter(e.interpolate(n,s));i.reset();for(let n=t.length-1;n>=0;n--)t[n]=i.filter(t[n])}function Ot(s,t,e,i){for(let n=0,h=s.length;n<h;n++)s[n]=i.filter(s[n]);i.reset();for(let n=s.length-1;n>=0;n--)s[n]=i.filter(s[n]);N(s,t,e)}class Dt extends B{toRIFF(){let t=new Float64Array(m(this.data.samples.length,this.dataType.bits/8));g(this.data.samples,this.dataType,t,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,t,{container:"RIFF"})}toRIFX(){let t=new Float64Array(m(this.data.samples.length,this.dataType.bits/8));g(this.data.samples,this.dataType,t,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,t,{container:"RIFX"})}toIMAADPCM(){if(this.fmt.sampleRate!==8e3)throw new Error("Only 8000 Hz files can be compressed as IMA-ADPCM.");if(this.fmt.numChannels!==1)throw new Error("Only mono files can be compressed as IMA-ADPCM.");{this.assure16Bit_();let t=new Int16Array(m(this.data.samples.length,2));g(this.data.samples,this.dataType,t,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"4",J(t),{container:this.correctContainer_()})}}fromIMAADPCM(t="16"){this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",Z(this.data.samples,this.fmt.blockAlign),{container:this.correctContainer_()}),t!="16"&&this.toBitDepth(t)}toALaw(){this.assure16Bit_();let t=new Int16Array(m(this.data.samples.length,2));g(this.data.samples,this.dataType,t,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8a",at(t),{container:this.correctContainer_()})}fromALaw(t="16"){this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",rt(this.data.samples),{container:this.correctContainer_()}),t!="16"&&this.toBitDepth(t)}toMuLaw(){this.assure16Bit_();let t=new Int16Array(m(this.data.samples.length,2));g(this.data.samples,this.dataType,t,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8m",ft(t),{container:this.correctContainer_()})}fromMuLaw(t="16"){this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",It(this.data.samples),{container:this.correctContainer_()}),t!="16"&&this.toBitDepth(t)}toBitDepth(t,e=!0){let i=t,n=this.bitDepth;e||(t!="32f"&&(i=this.dataType.bits.toString()),n=""+this.dataType.bits),this.assureUncompressed_();let h=this.getSamples(!0),a=new Float64Array(h.length);W(h,n,a,i),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,t,a,{container:this.correctContainer_()})}toSampleRate(t,e){this.validateResample_(t);let i=this.getSamples(),n=[];if(i.constructor===Float64Array)n=v(i,this.fmt.sampleRate,t,e);else for(let h=0;h<i.length;h++)n.push(v(i[h],this.fmt.sampleRate,t,e));this.fromExisting_(this.fmt.numChannels,t,this.bitDepth,n,{container:this.correctContainer_()})}validateResample_(t){if(X(this.fmt.numChannels,this.fmt.bitsPerSample,t)){if(["4","8a","8m"].indexOf(this.bitDepth)>-1)throw new Error("wavefile can't change the sample rate of compressed files.")}else throw new Error("Invalid sample rate.")}assure16Bit_(){this.assureUncompressed_(),this.bitDepth!="16"&&this.toBitDepth("16")}assureUncompressed_(){this.bitDepth=="8a"?this.fromALaw():this.bitDepth=="8m"?this.fromMuLaw():this.bitDepth=="4"&&this.fromIMAADPCM()}correctContainer_(){return this.container=="RF64"?"RIFF":this.container}fromExisting_(t,e,i,n,h){let a=new B;Object.assign(this.fmt,a.fmt),Object.assign(this.fact,a.fact),Object.assign(this.ds64,a.ds64),Object.assign(this.data,a.data),this.newWavFile_(t,e,i,n,h)}}function m(s,t){let e=s/t;return e%2&&e++,e}class Xt extends Dt{constructor(t){super(),t&&this.fromBuffer(t)}fromBase64(t){this.fromBuffer(H(t))}toBase64(){return j(this.toBuffer())}toDataURI(){return"data:audio/wav;base64,"+this.toBase64()}fromDataURI(t){this.fromBase64(t.replace("data:audio/wav;base64,",""))}}console.log("Extension content script loaded!");async function Nt(s){const t=await s.arrayBuffer(),i=await new(window.AudioContext||window.webkitAudioContext)().decodeAudioData(t),n=new Xt;return n.fromScratch(i.numberOfChannels,i.sampleRate,"32f",i.getChannelData(0)),new Blob([n.toBuffer()],{type:"audio/wav"})}const jt=document.querySelector("video");if(jt){console.log("Video detected");const s=document.createElement("button");s.textContent="ðŸŽ¥",Object.assign(s.style,{position:"fixed",top:"20px",right:"20px",zIndex:9999,padding:"10px",backgroundColor:"#ff4757",color:"white",border:"none",borderRadius:"6px",cursor:"pointer"}),document.body.appendChild(s),s.addEventListener("click",async()=>{try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0,selfBrowserSurface:"include"}),e=new MediaStream(t.getAudioTracks()),i=new MediaRecorder(e,{mimeType:"audio/webm"}),n=[];t.oninactive=()=>{i.state==="recording"&&(h.remove(),s.style.display="block",i.stop())},i.ondataavailable=a=>n.push(a.data),i.onstop=async()=>{t.active&&t.getTracks().forEach(u=>u.stop()),console.log("Recording stopped");const a=new Blob(n,{type:"audio/webm"}),l=await Nt(a);s.style.display="block",chrome.storage.local.get("gemini_api_key",u=>{const d=u.gemini_api_key;d?Ht(l,d).then(f=>{console.log(f),Vt(f)}).catch(f=>{console.error("Error generating quiz:",f)}):window.alert("No OpenAI API key found. Please set it in the extension popup.")})},s.style.display="none";const h=document.createElement("button");h.textContent="â¹ï¸",Object.assign(h.style,{position:"fixed",top:"20px",right:"20px",zIndex:9999,padding:"10px",backgroundColor:"#ff4757",color:"white",border:"none",borderRadius:"6px",cursor:"pointer"}),document.body.appendChild(h),h.addEventListener("click",()=>{i.state==="recording"&&(i.stop(),h.remove(),s.style.display="block")}),i.start(),console.log("Recording started")}catch(t){console.error("Error accessing screen/audio",t)}})}async function Ht(s,t){const i={contents:[{parts:[{inline_data:{mime_type:"audio/wav",data:await Wt(s)}},{text:"Generate a quiz based on the transcription of the audio. Format the quiz as a list of questions with multiple choice answers."}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"array",items:{type:"object",properties:{question:{type:"string"},options:{type:"array",items:{type:"object",properties:{text:{type:"string"},letter:{type:"string"}}}},answer_letter:{type:"string"}},propertyOrdering:["question","options","answer_letter"]}}}},n=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify(i)});if(!n.ok)throw new Error("Gemini API error: "+n.statusText);const a=(await n.json()).candidates?.[0]?.content?.parts?.[0]?.text;if(!a)throw new Error("No quiz data returned");let l;try{l=JSON.parse(a)}catch{throw console.error("Failed to parse JSON:",a),new Error("Malformed quiz response")}return l}async function Wt(s){return new Promise((t,e)=>{const i=new FileReader;i.onloadend=()=>{const n=i.result.split(",")[1];t(n)},i.onerror=e,i.readAsDataURL(s)})}function Vt(s){const t=window.open(chrome.runtime.getURL("quiz.html"),"_blank"),e=()=>t.postMessage(s,"*");t.onload=e,setTimeout(e,500)}
